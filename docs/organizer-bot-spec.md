# Техническое задание: Бот-организатор совместных закупок

## 1. Общее описание

Бот-организатор — автоматизированный модуль в рамках сервиса совместных закупок, который полностью заменяет роль человека-организатора. Бот самостоятельно инициирует, управляет и завершает процессы совместных закупок.

## 2. Основные функции

### 2.1 Публикация приглашений в совместные закупки

**Описание:** Бот автоматически создаёт и публикует приглашения на участие в совместных закупках по определённым категориям товаров.

**Алгоритм:**
1. Бот анализирует каталог товаров и определяет товары, по которым накопился достаточный спрос (на основе запросов пользователей и статистики).
2. Формирует приглашение с описанием:
   - Вид товара / категория
   - Предполагаемая выгода от совместной закупки
   - Минимальный и целевой объём закупки
   - Дедлайн для присоединения
3. Публикует приглашение в общий канал / чат сервиса.
4. Отправляет персональные уведомления целевым пользователям.

**API эндпоинты:**
- `POST /api/bot/procurements/auto-create/` — автоматическое создание закупки на основе спроса
- `POST /api/bot/invitations/send/` — рассылка приглашений

### 2.2 Приглашение целевых пользователей

**Описание:** Бот приглашает пользователей, в профиле которых упомянуты интересующие их виды товаров.

**Алгоритм:**
1. Получает список пользователей с совпадающими интересами из базы:
   - По тегам интересов в профиле пользователя
   - По истории участия в аналогичных закупках
   - По списку избранных категорий
2. Формирует персонализированное сообщение-приглашение.
3. Отправляет приглашения через все подключённые платформы (Telegram, WebSocket, VK).
4. Отслеживает прочитанность и ответы.

**Данные пользователя (расширение модели User):**
```
interests: Vec<String>       // теги интересов: ["продукты", "электроника", "одежда"]
favorite_categories: Vec<i32> // ID избранных категорий
notification_settings: JSON   // настройки уведомлений по категориям
```

### 2.3 Рассылка по поставщикам

**Описание:** Бот автоматически находит и оповещает поставщиков, предлагающих товары данной категории.

**Алгоритм:**
1. По категории закупки находит зарегистрированных поставщиков:
   - По совпадению категорий в профиле поставщика
   - По ключевым словам в описании прайс-листов
2. Отправляет запрос предложений (RFQ):
   - Описание требуемого товара
   - Ориентировочный объём
   - Желаемые сроки поставки
3. Собирает и систематизирует ответы поставщиков.
4. Формирует сводную таблицу предложений для голосования.

**API эндпоинты:**
- `POST /api/bot/suppliers/rfq/` — отправка запроса предложений
- `GET /api/bot/suppliers/responses/{procurement_id}/` — получение ответов

### 2.4 Голосование по поставщикам

**Описание:** Бот организует голосование участников закупки за выбор поставщика.

**Алгоритм:**
1. После сбора предложений от поставщиков бот создаёт голосование:
   - Публикует сводную таблицу: поставщик, цена, условия, рейтинг
   - Устанавливает дедлайн голосования
2. Участники голосуют за предпочитаемого поставщика.
3. По истечении дедлайна бот подводит итоги:
   - Определяет победителя (простое большинство)
   - Публикует результаты
4. При равенстве голосов — второй тур между лидерами.

**Модель данных:**
```sql
CREATE TABLE votes (
    id SERIAL PRIMARY KEY,
    procurement_id INTEGER REFERENCES procurements(id),
    user_id INTEGER REFERENCES users(id),
    supplier_id INTEGER REFERENCES users(id),
    comment TEXT DEFAULT '',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (procurement_id, user_id)
);
```

**API эндпоинты:**
- `POST /api/bot/votes/create/{procurement_id}/` — создание голосования
- `POST /api/bot/votes/cast/` — голосование
- `GET /api/bot/votes/results/{procurement_id}/` — результаты

### 2.5 Подведение итогов

**Описание:** Бот подводит итоги по количеству участников и их согласию на поставку.

**Алгоритм:**
1. После выбора поставщика бот:
   - Подсчитывает число согласных участников
   - Рассчитывает итоговую сумму заказа
   - Публикует сводку: количество участников, общая сумма, цена за единицу
2. Запрашивает финальное подтверждение у каждого участника.
3. Участники могут подтвердить или отказаться (с возвратом средств).
4. Формирует финальный список участников.

### 2.6 Сбор денежных средств

**Описание:** Бот инициирует и контролирует процесс сбора денег для оплаты поставщику.

**Алгоритм:**
1. После подтверждения участников:
   - Рассчитывает сумму для каждого участника
   - Отправляет уведомления с суммой к оплате
   - Устанавливает дедлайн оплаты
2. Принимает оплату через:
   - Внутренний баланс сервиса (списание с баланса пользователя)
   - Внешнюю платёжную систему (YooKassa)
3. Отслеживает статус оплаты каждого участника.
4. Отправляет напоминания неоплатившим.
5. При достижении 100% оплаты — инициирует перевод поставщику.
6. При неполной оплате к дедлайну — уведомляет организатора/принимает решение.

**API эндпоинты:**
- `POST /api/bot/collection/start/{procurement_id}/` — начало сбора
- `GET /api/bot/collection/status/{procurement_id}/` — статус сбора
- `POST /api/bot/collection/remind/{procurement_id}/` — напоминание

## 3. Архитектура

### 3.1 Компоненты

```
┌────────────────────────────────────────────────────────┐
│                    Бот-организатор                      │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────┐ │
│  │ Планировщик  │  │  Процессор   │  │  Нотификатор  │ │
│  │   задач      │  │  событий     │  │               │ │
│  └──────┬───────┘  └──────┬───────┘  └───────┬───────┘ │
│         │                  │                   │         │
│  ┌──────┴──────────────────┴───────────────────┴──────┐ │
│  │              Менеджер состояний                     │ │
│  └────────────────────────┬───────────────────────────┘ │
│                           │                              │
└───────────────────────────┼──────────────────────────────┘
                            │
              ┌─────────────┼─────────────┐
              │             │             │
      ┌───────┴──────┐ ┌───┴────┐ ┌──────┴──────┐
      │  REST API    │ │  БД    │ │  Платёжный  │
      │  (Rust)      │ │ Postgres│ │  шлюз      │
      └──────────────┘ └────────┘ └─────────────┘
```

### 3.2 Состояния закупки (управляемые ботом)

```
CREATED → INVITING → COLLECTING_PROPOSALS → VOTING →
CONFIRMING → PAYMENT_COLLECTING → PAID → DELIVERING → COMPLETED
```

### 3.3 Конфигурация бота

```toml
[organizer_bot]
# Минимальное количество участников для начала закупки
min_participants = 3

# Дедлайн голосования (часы)
voting_deadline_hours = 48

# Дедлайн оплаты (часы)
payment_deadline_hours = 72

# Автоматическая отмена при недоборе участников
auto_cancel_on_insufficient = true

# Интервал напоминаний об оплате (часы)
payment_reminder_interval_hours = 24

# Максимальное число напоминаний
max_payment_reminders = 3
```

## 4. Реализация на Rust

### 4.1 Модуль бота (core-rust/src/bot/)

```rust
// Основные трейты
trait OrganizerBot {
    async fn find_demand(&self) -> Vec<DemandSignal>;
    async fn create_procurement(&self, signal: DemandSignal) -> Result<Procurement>;
    async fn invite_users(&self, procurement_id: i32) -> Result<Vec<Invitation>>;
    async fn request_proposals(&self, procurement_id: i32) -> Result<Vec<SupplierProposal>>;
    async fn start_voting(&self, procurement_id: i32) -> Result<Vote>;
    async fn tally_votes(&self, procurement_id: i32) -> Result<VoteResult>;
    async fn start_collection(&self, procurement_id: i32) -> Result<Collection>;
    async fn process_payment(&self, collection_id: i32, user_id: i32) -> Result<Payment>;
}
```

### 4.2 Планировщик задач

Использует `tokio::time` для запуска периодических задач:
- Проверка спроса — каждые 6 часов
- Напоминания об оплате — каждые 24 часа
- Проверка дедлайнов — каждый час
- Обновление статистики — каждые 30 минут

## 5. Интеграция с существующим сервисом

Бот-организатор интегрируется как дополнительный модуль к Rust бэкенду:
1. Использует те же модели и базу данных
2. Работает через внутренние API вызовы (без HTTP)
3. Управляется через REST API для администрирования
4. Отправляет уведомления через существующую систему нотификаций (Telegram, WebSocket)

## 6. Метрики и мониторинг

- Количество автоматически созданных закупок
- Конверсия приглашений в участие
- Среднее время от создания до завершения закупки
- Процент успешных закупок (достигших стадии оплаты)
- Средний процент оплат в срок
